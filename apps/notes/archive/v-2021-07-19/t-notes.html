<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,user-scalable=no,minimum-scale=1.0,maximum-scale=1.0" />
	<meta name="description" content="">
	<meta name="date" content="2021-03-21">

	<title>notes</title>

	<style>

		body {
			box-sizing: border-box;
			font: 100% monospace;
			margin: 0;
		}

		main {
			height: 100vh;
			margin: 0 auto;
			overflow: hidden;
			resize: both;
			max-width: 50rem;
		}

		h1 {
			display: inline-box;
			margin: 0;
		}

		img {
			vertical-align: middle;
		}

		input {
			vertical-align: middle;
		}

		#divContentMain {

			margin: 0;
			padding: 0;
			width: 100%;
		}

		#textareaMain {
			height: calc(100vh - 5rem);
			padding: 0 0.5rem;
			width: 95%;
		}
	</style>
</head>

<body>

	<!-- <script src="xgp-xhr-get-put.js"></script> -->

	<main>
		<h1>
			<a href="https://github.com/pushme-pullyou/tootoo-2021/tree/main/apps/notes" target="_blank"
				title="source code on GitHub"><img
					src=https://pushme-pullyou.github.io/tootoo-2021/lib/assets/icons/mark-github.svg></a>
			<a href="" title="Click this menu title to reload the file">
				tNotes
				<span id=spnVersion></span></a>

			<input id=XGPinpAccessToken onclick=this.select(); onblur=XGP.setGitHubAccessToken();
				title="Obtain GitHub API Access Token">

			<input type=date oninput=XGP.getDate(this);>

		</h1>

		<button onclick=XGP.getNew()>new</button>

		<button onclick=XGP.setStorageTnotes()>set</button>

		<button onclick=XGP.getStorageTnotes()>get</button>

		<button onclick=XGP.getToday()>tdy</button>

		<button onclick=XGP.getYesterday()>ydy</button>

		<button onclick=XGP.getToDo()>tdo</button>

		<button onclick=XGP.getNotes()>nts</button>

		<button onclick=XGP.getTips()>tps</button>

		<button onclick=XGP.putFileToGitHub() title="Press Alt-S">putToGitHub</button>

		<div id=divMessage></div>

		<div id="divContentMain"></div>

	</main>

	<script>

		// XMLHTTPRequest GitHub Push (XGP)

		const XGP = {
			user: "theo-armour",
			repo: "qdata",
			branch: "master",
			base: "https://api.github.com/repos/theo-armour/qdata/contents/",
			Date: new Date(),
			defaultFile: "notes.md"
		};



		XGP.init = function () {

			spnVersion.innerHTML = document.head.querySelector( "[ name=date ]" ).content;

			XGP.month = ( 1 + XGP.Date.getMonth() ).toString().padStart( 2, "0" );

			XGP.accessToken = localStorage.getItem( 'githubAccessToken' ) || "";
			XGPinpAccessToken.value = XGP.accessToken;

			window.addEventListener( "beforeunload", XGP.checkForChange );
			window.addEventListener( 'keyup', XGP.onKeyUp, false ); // Save file Alt--S
			window.addEventListener( 'hashchange', XGP.onHashChange, false );

			XGP.onHashChange();

			if ( location.protocol === "https:" ) {

				window.history.pushState( "", "", "../" + location.hash );

			}

		};



		XGP.test = function () {

			XGP.url = "";

			const date = XGP.Date.getDate().toString().padStart( 2, "0" );

			//location.hash = XGP.base + `journal/days-of-year-md/${ XGP.month }/${ XGP.month }-${ date }.md`;

			location.hash = XGP.base + "README.md"

		}


		XGP.setGitHubAccessToken = function () {

			localStorage.setItem( "githubAccessToken", XGPinpAccessToken.value );

		};



		XGP.discardOK = function () {

			let result;

			if ( textareaMain.value !== XGP.content ) { result = confirm( "OK to discard?" ); }

			return result;

		};


		XGP.getNew = function () {

			if ( XGP.discardOK() === false ) { return; }

			XGP.url = "";

			const content = "";

			textareaMain.value = content;

			XGP.content = content;

		};



		XGP.getToday = function () {

			if ( XGP.discardOK() === false ) { return; };

			const date = XGP.Date.getDate().toString().padStart( 2, "0" );

			const path = `journal/days-of-year-md/${ XGP.month }/${ XGP.month }-${ date }.md`;

			XGP.url = XGP.base + path;

			XGP.onHashChange();

		};



		XGP.getYesterday = function () {

			if ( XGP.discardOK() === false ) { return; };

			const date = ( XGP.Date.getDate() - 1 ).toString().padStart( 2, "0" );

			const path = `journal/days-of-year-md/${ XGP.month }/${ XGP.month }-${ date }.md`;

			XGP.url = XGP.base + path;

			XGP.onHashChange();

		};


		XGP.getDate = function ( that ) {

			const dateString = that.value;

			if ( XGP.discardOK() === false ) { return; };

			console.log( "dateString", dateString );
			XGP.date = dateString.slice( -2 );
			XGP.month = dateString.slice( 5, 7 );

			const path = `journal/days-of-year-md/${ XGP.month }/${ XGP.month }-${ XGP.date }.md`;

			console.log( "path", path );

			XGP.url = XGP.base + path;

			XGP.onHashChange();

		};



		XGP.getToDo = function () {

			if ( XGP.discardOK() === false ) { return; };

			const date = XGP.Date.getDate().toString().padStart( 2, "0" );

			const path = `0-to-do/0-to-do.md`;

			XGP.url = XGP.base + path;

			XGP.onHashChange();

		};


	XGP.getTips= function () {

		if ( XGP.discardOK() === false ) { return; };

		const date = XGP.Date.getDate().toString().padStart( 2, "0" );

		const path = `apps/trayo/tips.md`;

		XGP.url = XGP.base + path;

		XGP.onHashChange();

	};

		XGP.getNotes = function () {

			if ( XGP.discardOK() === false ) { return; };

			const path = XGP.defaultFile;

			XGP.url = XGP.base + path;

			XGP.onHashChange();

		};



		XGP.onHashChange = function ( event ) {

			//console.log( "location.hash ", location.hash.length );

			if ( XGP.url ) {

			} else if ( location.hash.length > 1 ) {

				XGP.url = location.hash.slice( 1 );

			} else {

				XGP.url = `https://api.github.com/repos/${ XGP.user }/${ XGP.repo }/contents/${ XGP.defaultFile }`;

			}

			console.log( "XGP.url ", XGP.url );

			const xhr = new XMLHttpRequest();
			xhr.open( "GET", XGP.url, true );
			xhr.setRequestHeader( "Authorization", "token " + XGP.accessToken );
			xhr.responseType = "json";
			xhr.onerror = ( xhr ) => console.log( "error:", xhr );
			//xhr.onprogress = ( xhr ) => console.log( "bytes loaded:", xhr.loaded );
			xhr.onload = XGP.onLoad;
			xhr.send( null );

		};



		XGP.onLoad = function ( xhr ) {
			//console.log( "response", xhr );

			XGP.sha = xhr.target.response.sha;

			const content = atob( xhr.target.response.content );

			divContentMain.innerHTML = `<textarea id=textareaMain style="" ></textarea>`;

			textareaMain.value = content;

			XGP.content = content;

			if ( window.divMessage ) {

				//divMessage.innerText = `Get:${ new Date().toLocaleString() } bytes:${ content.length } sha:${ XGP.sha }`;
				divMessage.innerText = `Get:${ new Date().toLocaleString() } bytes:${ content.length }`;

			}

		};



		XGP.putFileToGitHub = function () {

			if ( XGP.url === "" ) { alert( "No URL" ); return; }

			const xhr = new XMLHttpRequest();
			xhr.open( "GET", XGP.url, true );
			xhr.setRequestHeader( "Authorization", "token " + XGP.accessToken );
			xhr.responseType = "json";
			xhr.onerror = ( xhr ) => console.log( "error:", xhr );
			//xhr.onprogress = ( xhr ) => console.log( "bytes loaded:", xhr.loaded );
			xhr.onload = ( xhr ) => {
				//console.log( "", xhr );
				XGP.sha = xhr.target.response.sha;
				XGP.putFile();
			};
			xhr.send( null );

		};



		XGP.putFile = function () {

			XGP.content = textareaMain.value;

			const codedData = window.btoa( XGP.content ); // encode the string

			const body = JSON.stringify( {
				"branch": XGP.branch,
				"content": codedData,
				"message": `add to file`,
				"sha": XGP.sha

			} );

			xhr = new XMLHttpRequest();
			xhr.open( "PUT", XGP.url, true );
			xhr.setRequestHeader( "Authorization", "token " + XGP.accessToken );
			xhr.setRequestHeader( "Content-Type", "application/json" );
			xhr.onerror = ( xhr ) => console.log( "error:", xhr );
			xhr.onprogress = ( xhr ) => console.log( "bytes loaded:", xhr.loaded );
			xhr.send( body );

			//divMessage.innerText = `Put: ${ new Date().toLocaleString() } bytes:${ XGP.content.length } sha:${ XGP.sha }`;
			divMessage.innerText = `Put: ${ new Date().toLocaleString() } bytes:${ XGP.content.length }`;

		};



		XGP.checkForChange = function ( event ) {

			if ( textareaMain.value === XGP.content ) { return; }

			event.preventDefault();

			event.returnValue = "";

		};



		XGP.setStorageTnotes = function () {

			localStorage.setItem( "tnotesText", textareaMain.value );

		};



		XGP.getStorageTnotes = function () {

			XGP.url = "";

			textareaMain.value = localStorage.getItem( "tnotesText" );

			XGP.content = localStorage.getItem( "tnotesText" ) || "";
			textareaMain.value.value = XGP.content;

		};



		XGP.onKeyUp = function () {

			//console.log( 'key', event.keyCode );

			event.preventDefault();

			if ( event.altKey && event.keyCode === 83 ) {

				XGP.putFileToGitHub();

			}

		};


		XGP.init();


	</script>

</body>

</html>